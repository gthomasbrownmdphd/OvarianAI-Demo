<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Follicle Detection Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
<style>
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  #topbar { padding: 10px; }
  #viewer { width: 100%; height: 720px; background: #0b0b0b; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; }
  #layer-controls, #buttons { padding: 10px; }
  #status { padding: 10px; display:none; }
  #status.error { display:block; color:#721c24; background:#f8d7da; border:1px solid #f5c6cb; margin:10px; border-radius:6px; }
  #status.ok { display:block; color:#155724; background:#d4edda; border:1px solid #c3e6cb; margin:10px; border-radius:6px; }
  .leaflet-container { background: transparent !important; }
</style>
</head>
<body>

<div id="topbar">
  <h2 style="margin:0 0 6px 0;">Ovarian AI Follicle Detection Demo</h2>
  <div>Tile source: <code id="dziPathLabel"></code></div>
</div>

<div id="status" class=""></div>
<div id="viewer"></div>

<div id="buttons">
  <button id="btn-zoom-initial">Zoom in a bit</button>
  <button id="btn-home">Go Home</button>
</div>

<div id="layer-controls">
  <label><input type="checkbox" class="layer-toggle" data-layer="Ground Truth" checked> Ground Truth</label><br>
  <label><input type="checkbox" class="layer-toggle" data-layer="Object Detection" checked> Object Detection</label><br>
  <label><input type="checkbox" class="layer-toggle" data-layer="Segmentation" checked> Segmentation</label><br>
  <label><input type="checkbox" class="layer-toggle" data-layer="Merged" checked> Merged</label><br>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// ===== CONFIG =====
const dziPath = "17126465_dzi.dzi";
const layers = {
  "Ground Truth": "17126465.json",
  "Object Detection": "od_preds_view.geojson",
  "Segmentation": "segm_preds_view.geojson",
  "Merged": "merged_preds_view.geojson"
};
const layerColors = {
  "Ground Truth": "#E69F00",
  "Object Detection": "#56B4E9",
  "Segmentation": "#009E73",
  "Merged": "#D55E00"
};

document.getElementById('dziPathLabel').textContent = dziPath;

function setStatus(msg, ok=false) {
  const el = document.getElementById('status');
  el.className = ok ? 'ok' : 'error';
  el.innerHTML = msg;
  el.style.display = 'block';
  console[ok ? 'log' : 'error'](msg.replace(/<[^>]*>/g, ''));
}

// ===== OpenSeadragon =====
const viewer = OpenSeadragon({
  id: "viewer",
  prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/images/",
  tileSources: dziPath,
  showNavigator: true,
  showZoomControl: true,
  gestureSettingsMouse: { clickToZoom: false, dblClickToZoom: true, scrollToZoom: true }
});

viewer.addHandler('open', () => {
  setStatus("DZI opened successfully.", true);
  // If you want default initial zoom, remove the next two lines.
  const home = viewer.viewport.getHomeZoom();
  viewer.viewport.zoomTo(home * 1.5, viewer.viewport.getCenter(), true);
});

viewer.addHandler('open-failed', (e) => setStatus("Failed to open DZI. Check that <code>"+dziPath+"</code> and the *_files folder exist.", false));
viewer.addHandler('tile-load-failed', (e) => setStatus("Tile load failed: check Network tab for the URL.", false));

// Buttons
document.getElementById('btn-zoom-initial').addEventListener('click', () => {
  viewer.viewport.zoomTo(viewer.viewport.getZoom() * 4, null, true);
});
document.getElementById('btn-home').addEventListener('click', () => viewer.viewport.goHome(true));

// ===== Leaflet overlay =====
let overlays = {};
viewer.addHandler('open', function () {
  const leafletDiv = document.createElement('div');
  Object.assign(leafletDiv.style, {
    position: 'absolute', top: '0', left: '0', width: '100%', height: '100%',
    pointerEvents: 'none', background: 'transparent', zIndex: 1
  });
  viewer.container.appendChild(leafletDiv);

  const map = L.map(leafletDiv, {
    crs: L.CRS.Simple,
    zoomControl: false,
    attributionControl: false,
    dragging: false, scrollWheelZoom: false, doubleClickZoom: false,
    boxZoom: false, keyboard: false, tap: false
  }).setView([0, 0], 0);

  const size = viewer.world.getItemAt(0).getContentSize();
  map.fitBounds([[0,0],[size.y, size.x]]);

  viewer.addHandler('animation', function () {
    const center = viewer.viewport.getCenter();
    const centerPx = viewer.viewport.viewportToImageCoordinates(center);
    map.setView([centerPx.y, centerPx.x], map.getZoom(), { animate: false });
  });

  for (const [name, path] of Object.entries(layers)) {
    fetch(path)
      .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status} for ${path}`); return r.json(); })
      .then(geojson => {
        const layer = L.geoJSON(geojson, {
          style: () => ({ color: layerColors[name], weight: 1.5, fillOpacity: 0.2 })
        });
        layer.addTo(map);
        overlays[name] = layer;
      })
      .catch(err => setStatus(`Failed to load layer <code>${name}</code> from <code>${path}</code>: ${err.message}`, false));
  }

  document.querySelectorAll('.layer-toggle').forEach(cb => {
    cb.addEventListener('change', e => {
      const layer = overlays[e.target.dataset.layer];
      if (!layer) return;
      if (e.target.checked) layer.addTo(map); else map.removeLayer(layer);
    });
  });
});
</script>
</body>
</html>
